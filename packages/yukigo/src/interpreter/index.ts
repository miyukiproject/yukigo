import { PrimitiveValue, Expression, AST, EnvStack, ASTNode } from "yukigo-ast";
import { InterpreterVisitor } from "./components/Visitor.js";
import { EnvBuilderVisitor } from "./components/EnvBuilder.js";
import { InterpreterError } from "./errors.js";
import { define } from "./utils.js";
import { idContinuation, trampoline } from "./trampoline.js";

export type Bindings = [string, PrimitiveValue][];

export type LogicSearchMode = "first" | "all" | "stream";
export type InterpreterConfig = {
  lazyLoading?: boolean;
  debug?: boolean;
  outputMode?: LogicSearchMode;
  mutability?: boolean;
};

export const DefaultConfiguration: Required<InterpreterConfig> = {
  lazyLoading: false,
  debug: false,
  outputMode: "first",
  mutability: true,
};

/**
 * The Interpreter class is responsible for evaluating the Abstract Syntax Tree (AST)
 * generated by the parsers.
 *
 * It manages the global execution environment and delegates the actual evaluation
 * of Expression nodes to a dedicated visitor.
 */
export class Interpreter {
  private globalEnv: EnvStack;
  private readonly config: Required<InterpreterConfig>;

  /**
   * @param ast The Abstract Syntax Tree (AST) of the program to be interpreted.
   */
  constructor(ast: AST, config?: InterpreterConfig) {
    this.globalEnv = new EnvBuilderVisitor().build(ast);
    this.config = { ...DefaultConfiguration, ...config };
  }

  public define(name: string, value: PrimitiveValue): void {
    define(this.globalEnv, name, value);
  }

  /**
   * Evaluates a single Expression node within the context of the global environment.
   *
   * @param expr The root Expression node to be evaluated.
   * @returns The resulting primitive value (number, string, boolean, etc.) after evaluation.
   */
  public evaluate(expr: ASTNode): PrimitiveValue {
    try {
      const visitor = new InterpreterVisitor(this.globalEnv, this.config);
      const evaluatedCPS = expr.accept(visitor);
      return trampoline(evaluatedCPS(idContinuation));
    } catch (error) {
      if (error instanceof InterpreterError) console.log(error.formatStack());
      throw error;
    }
  }
}
